<link rel="import" href="/bower_components/polymer/polymer.html">

<dom-module id="job-cube">
    <link rel='stylesheet' href='job-cube.css'>

    <template>
        <div id='cube' status$='{{status}}' show$='{{show}}'>
            <div class='face front'>
                <div class='big-name'>[[name]]</div>
                <div>
                    <template is="dom-repeat" items$="[[info.healthReport]]">
                        <span>[[item.description]]</span>
                    </template>
                </div>
                <div class='build-number'>[[report.displayName]]</div>
                <div class='timestamp'>[[lastBuildDate]]</div>
            </div>
            <div class='face back'>
                <div class='name'>[[name]]</div>
                Back
            </div>
            <div class='face left'>
                <div class='name'>[[name]]</div>
                Left
            </div>
            <div class='face right'>
                <div class='big-name'>Building</div>
                <div class='name'>[[name]]</div>
                <div class='build-progress'>
                    <span>[[report.executor.progress]]</span>
                    <span>%</span>
                </div>
                <div class='build-number'>[[report.displayName]]</div>
            </div>
            <div class='face top'>
                <div class='name'>[[name]]</div>
            </div>
            <div class='face bottom'>
                <div>Last commit from:</div>
                <div class='big-name'>[[author]]</div>
                <div class='name'>[[name]]</div>
                <div class='build-number'>[[report.displayName]]</div>
            </div>
        </div>
        <iron-ajax id='job_info'
                   url='/job_info'
                   handle-as="json"
                   on-response="handleJobInfoResponse"
                   debounce-duration="300">
        </iron-ajax>
        <iron-ajax id='last_build_report'
                   url='/last_build_report'
                   handle-as="json"
                   on-response="handleLastBuildReportResponse"
                   debounce-duration="300">
        </iron-ajax>
    </template>

    <script>
        Polymer({
            is: 'job-cube',

            // Properties
            properties: {
                status: {
                    type: String,
                    value: 'red',
                    reflectToAttribute: true,
                    notify: true,
                    observer: '_observeStatusChange'
                },
                show: {
                    type: String,
                    value: 'front'
                },
                name: {
                    type: String,
                    value: 'hi!',
                    reflectToAttribute: true
                },
                url: {
                    type: String,
                    value: '',
                    reflectToAttribute: true
                },
                report: {
                    type: Object,
                    value: {}
                },
                info:  {
                    type: Object,
                    value: {}
                },
                author: String,
                lastBuildDate: Date
            },
            cycle: null,
            oldBuildNumber: '0',
            ready: function () {
                var that = this;

                var last_build_report_ajax = this.$.last_build_report;
                last_build_report_ajax.params = { name: this.name };
                last_build_report_ajax.generateRequest();

                var job_info_ajax = this.$.job_info;
                job_info_ajax.params = { name: this.name };
                job_info_ajax.generateRequest();

                this.cycle = function () {
                    last_build_report_ajax.generateRequest();
                    job_info_ajax.generateRequest();

                    var newShow = 'front';
                    if (that.report !== null && that.report.building) {
                        newShow = 'spin';
                    } else {
                        switch (that.show) {
                            case "front":
                                if (that.author && that.author.length > 0) {
                                    newShow = 'bottom';
                                }
                                break;
                            case "bottom":
                                newShow = 'front';
                                break;
                            case "top":
                                newShow = 'left';
                                break;
                            case "left":
                                newShow = 'right';
                                break;
                            case "right":
                                newShow = 'front';
                                break;
                        }
                    }
                    that.show = newShow;
                };

                setInterval(this.cycle, 10000);
            },
            _observeStatusChange: function (newStatus, oldStatus) {
                if (this.cycle !== null)
                    this.cycle();
            },
            // Functions
            handleJobInfoResponse: function (e) {
                this.info = e.detail.response;
            },
            handleLastBuildReportResponse: function (e) {
                var report = e.detail.response;
                this.report = report;
                if (report === null) {
                    return;
                }
                if (report.changeSet && report.changeSet.items.length > 0) {
                    this.author = report.changeSet.items[0].author.fullName;
                   
                }
                if (report.timestamp){
                    var date = new Date(report.timestamp);
                    var minutes = date.getMinutes().toString().substr(-2);
                    if (minutes.length === 1) {
                        minutes = '0' + minutes;
                    }

                    this.lastBuildDate = date.getDay() + '/' + date.getMonth() + '/' + date.getFullYear() + ' ' +
                    date.getHours().toString() + ':' + minutes;
                }
            }
        });
    </script>
</dom-module>