<link rel="import" href="/bower_components/polymer/polymer.html">

<dom-module id="job-cube">
  <link rel='stylesheet' href='job-cube.css'>

  <template>
    <div id='cube' status$='{{status}}' show$='{{show}}'>
      <div class='face front'>
        <div class='bigger'>[[info.displayName]]</div>
        <div>          
          <template is="dom-repeat" items$="[[info.healthReport]]">
              <span>[[item.description]]</span>
          </template>
        </div>
        <div class='bigger build-number'>
          <span>#</span>
          <span>[[info.lastBuild.number]]</span>                   
        </div>
        <div class='align-bottom'>[[lastBuildDate]]</div>
      </div>
      <div class='face back'>
        <div class='align-bottom'>[[info.displayName]]</div>
        <div class='smaller'>Calculated Technical Debt</div>
        <div class='bigger'>3 hours</div>
        <div class='smaller'>Potential Issues</div>
        <div class='bigger'>133,000</div>
        <div class='smaller'>SQALE Rating</div>
        <div class='bigger'>B</div>
      </div>
      <div class='face left'>
        <div class='align-bottom'>[[info.displayName]]</div>
        Left
      </div>
      <div class='face right'>        
        <div class='bigger'>Building</div>
        <div class='align-bottom'>[[info.displayName]]</div>
        <div class='build-progress'>
          <span>[[report.executor.progress]]</span>    
          <span>%</span>
        </div>        
      </div>
      <div class='face top'>
        <div class='smaller'>Unit Tests</div>
        <div class='bigger'>123 Passed</div>
        <div class='bigger'>3 Failed</div>
        <div class='bigger'>0 Skipped</div>
        <div class='smaller'>Code Coverage</div>
        <div class='bigger'>87%</div>
        <div class='align-bottom'>[[info.displayName]]</div>
      </div>
      <div class='face bottom'>
        <div class='smaller'>Last commit from</div>
        <div class='bigger'>[[culprit]]</div>
        <div class='smaller'>Total contributers</div>
        <div class='bigger'>4</div>
        <div class='align-bottom'>[[info.displayName]]</div>
      </div>
    </div>
    <iron-ajax id='job_info'       
      url='/job_info' 
      handle-as="json" 
      on-response="handleJobInfoResponse" 
      debounce-duration="300">
    </iron-ajax>
    <iron-ajax id='last_build_report'       
      url='/last_build_report' 
      handle-as="json" 
      on-response="handleLastBuildReportResponse" 
      debounce-duration="300">
    </iron-ajax>
  </template>

  <script>
    Polymer({
      is: 'job-cube',
      
      // Properties
      properties: {
        status: {
          type: String,      
          value: 'red',
          reflectToAttribute: true,
          notify: true,          
          observer: '_observeStatusChange'
        },
        show: {
          type: String,   
          value: 'front'
        },
        name: {
          type: String,
          value:  'hi!',        
          reflectToAttribute: true  
        },
        url: {
          type: String,
          value:  '',        
          reflectToAttribute: true  
        },
        info: {
          type: Object,
          value: {}
        },    
        build: {
          type: Object,
          value: {}
        },  
        report: {
          type: Object,
          value: {}
        },
        culprit: String,
        lastBuildDate: Date      
      },
      buildHealth: function(){
        var i;
        if(this.info !== null){
          return "Loading";
        }
        
        var healthReport = this.info.healthReport;
        for(i = 0; i < healthReport.length; i++){
          return healthReport.description;
        }
      },
      cycle: null,
      oldBuildNumber: '0',
      ready: function(){
        var that = this;
        var job_info_ajax = this.$.job_info;
        job_info_ajax.params = {name: this.name};
        job_info_ajax.generateRequest();
        this.cycle = function(){
          var newShow = 'front';
          if(that.report.building){
            newShow = 'right';
          } else {
            switch(that.show){
              case "front":              
                if(that.report.culprits && that.report.culprits.length > 0) {
                  newShow = 'bottom';                  
                }
              break;
              case "bottom":
                newShow = 'back';
              break;
              case "back":
                newShow = 'top';
              break;
              case "top":
                newShow = 'front';                
              break;            
              case "left":
                newShow = 'back';
              break;            
              case "right":
                newShow = 'back';
              break;
            }
          }
          that.show = newShow;
          job_info_ajax.generateRequest();
        };
        
       // setInterval(this.cycle, 2000);
      },
      _observeStatusChange: function(newStatus, oldStatus){
        if(this.cycle !== null)        
          this.cycle();
      },
      // Functions
      handleJobInfoResponse: function(e) {        
        this.info = e.detail.response;       
        
        var last_build_report_ajax = this.$.last_build_report;
        last_build_report_ajax.params = {name: this.name};       
        last_build_report_ajax.generateRequest();
                
        setTimeout(this.cycle, 3000);  
      },
      handleLastBuildReportResponse: function(e) {  
        var report = e.detail.response;
        this.report = report; 
        if(report.executor !== null){
          console.log(report.executor);
        }
        if(report.culprits !== null && report.culprits.length > 0){
          this.culprit = report.culprits[0].fullName;
          var date = new Date(report.timestamp);
          this.lastBuildDate = date.getDay() + '/' + date.getMonth() + '/' + date.getFullYear() + ' ' +
          date.getHours().toString() + ':' + date.getMinutes().toString().substr(-2);
        }
        
      }
    });
  </script>
</dom-module>